import { h, watch, computed, defineComponent, ref, unref } from 'vue';
import { useColors } from '../../composables/use-colors';
import { VDataTableHeader } from './VDataTableHeader';
import { VDataTableBody } from './VDataTableBody';
import { VDataTableFooter } from './VDataTableFooter';
import { addScopedSlot } from '../../helpers';
export default defineComponent({
    name: 'v-data-table',
    props: {
        cols: {
            type: Array,
            default: () => [],
        },
        rows: {
            type: Array,
            default: () => [],
        },
        showSequence: Boolean,
        showCheckbox: Boolean,
        align: {
            type: String,
            validator: (val) => ['left', 'center', 'right'].includes(val),
        },
        color: {
            type: String,
            default: '',
        },
        headerOptions: {
            type: Object,
            default: () => ({}),
        },
        footerOptions: {
            type: Object,
            default: null,
        },
        customFilter: Function,
    },
    emits: [
        'last-page',
        'sort:column',
        'filter:column',
        'select:row',
        'click:row',
        'dblclick:row',
        'update:page',
        'update:rows',
        'update:rows-count',
        'contextmenu:row',
    ],
    setup(props, { slots, emit }) {
        const cols = ref([]);
        const rows = ref([]);
        const page = ref(1);
        const rowsOnPage = ref(props.footerOptions?.counts?.rowsPerPageOptions?.[0] || 5);
        const checkedRows = ref([]);
        const isAllRowsChecked = ref(false);
        const { setBackgroundCssColor, setBackgroundClassNameColor } = useColors();
        const filters = {};
        const classes = computed(() => ({
            'v-data-table': true,
            ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
        }));
        const styles = computed(() => ({
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        const headerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.headerOptions,
        }));
        const footerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.footerOptions,
        }));
        const totalRowsCount = computed(() => {
            return props.footerOptions?.counts?.totalRows || unref(rows)?.length;
        });
        const pages = computed(() => {
            return Math.ceil(unref(rows)?.length / unref(rowsOnPage));
        });
        const firstOnPage = computed(() => {
            return unref(page) === 1 ? 1 : (unref(page) - 1) * unref(rowsOnPage) + 1;
        });
        const lastOnPage = computed(() => {
            return unref(page) * unref(rowsOnPage) > unref(totalRowsCount)
                ? unref(totalRowsCount)
                : unref(page) * unref(rowsOnPage);
        });
        watch(() => props.cols, (newCols) => (cols.value = newCols), { immediate: true });
        watch(() => props.rows, (newRows) => rows.value = newRows, { immediate: true });
        watch(() => props.rows.length, (length) => emit('update:rows', { page, length }), { immediate: true });
        const onSelectAll = (value) => {
            isAllRowsChecked.value = value;
            unref(rows).forEach((row) => (row.checked = value));
        };
        const onSelect = (rows) => {
            checkedRows.value = rows;
            emit('select:row', unref(checkedRows));
        };
        const onPrevPage = (num) => {
            page.value = unref(page) > 1 ? unref(page) + num : unref(page);
            emit('update:page', unref(page));
        };
        const onNextPage = (num) => {
            if (unref(totalRowsCount) - unref(page) * unref(rowsOnPage) > 0) {
                page.value += num;
            }
            emit('update:page', unref(page));
        };
        const onSort = (col) => {
            if (col.sorted) {
                col.sorted = !col.sorted;
                return sortColumn(col);
            }
            unref(cols).forEach((c) => (c.sorted = col.key === c.key));
            sortColumn(col);
        };
        const sortColumn = (col) => {
            if (col.emit) {
                return emit('sort:column', col);
            }
            if (!col.sorted) {
                return unref(rows)?.reverse();
            }
            const executor = col.sort ||
                ((a, b) => {
                    if (col.format)
                        return col.format(a) > col.format(b) ? 1 : -1;
                    if (col.sorted)
                        return a[col.key] > b[col.key] ? 1 : -1;
                });
            unref(rows)?.sort(executor);
        };
        const onFilter = ({ value, col }) => {
            if (col.emit) {
                return emit('filter:column', { value, col });
            }
            if (!value && filters[col.key]) {
                delete filters[col.key];
            }
            if (value) {
                filters[col.key] = value;
            }
            if (col.filter) {
                return (rows.value = col.filter({ value, col }));
            }
            if (props.customFilter) {
                return props.customFilter(filters);
            }
            if (!Object.keys(filters).length) {
                return (rows.value = props.rows);
            }
            rows.value = filterRows(props.rows, props.cols);
            page.value = 1;
        };
        const onSelectRowsCount = (count) => {
            rowsOnPage.value = count;
            emit('update:rows-count', unref(rowsOnPage));
        };
        const filterRows = (rows, cols) => {
            const filterKeys = Object.keys(filters);
            return rows.reduce((acc, row) => {
                const rowResults = [];
                filterKeys.forEach((key) => {
                    const { format } = cols.find((col) => col.key === key);
                    const value = format ? format(row) : row[key];
                    const rowKeyValue = `${value}`.toLowerCase();
                    const filterValue = `${filters[key]}`.toLowerCase();
                    if (rowKeyValue.includes(filterValue)) {
                        rowResults.push(row[key]);
                    }
                });
                if (rowResults.length === filterKeys.length &&
                    rowResults.every((value) => !!value)) {
                    acc.push(row);
                }
                return acc;
            }, []);
        };
        const genTableTools = () => {
            const propsData = { class: 'v-data-table__toolbar' };
            return h('div', propsData, {
                default: () => slots.toolbar && slots.toolbar(),
            });
        };
        const genTableHeader = () => {
            const propsData = {
                cols: unref(cols),
                color: props.color,
                showCheckbox: props.showCheckbox,
                dark: props.dark,
                align: props.align,
                showSequence: props.showSequence,
                options: unref(headerOptions),
                onFilter,
                onSort,
                onSelectAll,
            };
            const content = unref(cols).reduce((acc, col) => {
                const slotName = `${col.key}-filter`;
                if (col && slots[slotName]) {
                    acc[slotName] = addScopedSlot(slotName, slots);
                }
                return acc;
            }, {});
            content.header = addScopedSlot('header', slots);
            return h(VDataTableHeader, propsData, content);
        };
        const genTableBody = () => {
            const propsData = {
                cols: unref(cols),
                rows: unref(rows),
                page: unref(page),
                rowsOnPage: unref(rowsOnPage),
                checkAllRows: unref(isAllRowsChecked),
                showCheckbox: props.showCheckbox,
                align: props.align,
                dark: props.dark,
                showSequence: props.showSequence,
                color: props.color,
                onSelect,
                ['onClick:row']: (e) => emit('click:row', e),
                ['onDblclick:row']: (e) => emit('dblclick:row', e),
                ['onContextmenu:row']: (e) => emit('contextmenu:row', e),
            };
            const content = props.cols.reduce((acc, col) => {
                if (col && slots[col.key]) {
                    acc[col.key] = addScopedSlot(col.key, slots);
                }
                return acc;
            }, {});
            return h(VDataTableBody, propsData, content);
        };
        const genTableFooter = () => {
            const propsData = {
                pages: unref(pages),
                page: unref(page),
                firstOnPage: unref(firstOnPage),
                lastOnPage: unref(lastOnPage),
                rowsOnPage: unref(rowsOnPage),
                rowsLength: unref(totalRowsCount),
                options: unref(footerOptions),
                onPrevPage,
                onNextPage,
                onSelectRowsCount,
            };
            const content = slots['pagination-text']
                ? {
                    ['pagination-text']: () => slots['pagination-text']?.({
                        start: unref(firstOnPage),
                        last: unref(lastOnPage),
                        length: unref(totalRowsCount),
                    }),
                }
                : '';
            return h(VDataTableFooter, propsData, content);
        };
        const genTableInner = () => {
            const propsData = {
                class: 'v-data-table__inner',
            };
            return h('div', propsData, [genTableHeader(), genTableBody()]);
        };
        return () => {
            const propsData = {
                class: unref(classes),
                style: unref(styles),
            };
            return h('div', propsData, [
                slots.toolbar && genTableTools(),
                genTableInner(),
                genTableFooter(),
            ]);
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3Z1ZWxhbmQvc3JjL2NvbXBvbmVudHMvVkRhdGFUYWJsZS9WRGF0YVRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLEtBQUssQ0FBQTtBQUdyRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFJeEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDckQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBR3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFZN0MsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLGNBQWM7SUFDcEIsS0FBSyxFQUFFO1FBQ0wsSUFBSSxFQUFFO1lBQ0osSUFBSSxFQUFFLEtBQUs7WUFDWCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtTQUNsQjtRQUNELElBQUksRUFBRTtZQUNKLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7U0FDbEI7UUFDRCxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsT0FBTztRQUNyQixLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7U0FDOUQ7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZ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QztnQkFDdEMsQ0FBQyxDQUFDO29CQUNBLENBQUMsaUJBQWlCLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FDeEIsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQzt3QkFDekIsS0FBSyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUM7d0JBQ3pCLElBQUksRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDO3dCQUN2QixNQUFNLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQztxQkFDOUIsQ0FBQztpQkFDTDtnQkFDRCxDQUFDLENBQUMsRUFBRSxDQUFBO1lBRU4sT0FBTyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ2hELENBQUMsQ0FBQTtRQUVELE1BQU0sYUFBYSxHQUFHLEdBQVUsRUFBRTtZQUNoQyxNQUFNLFNBQVMsR0FBRztnQkFDaEIsS0FBSyxFQUFFLHFCQUFxQjthQUM3QixDQUFBO1lBRUQsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLGNBQWMsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRSxDQUFDLENBQUE7UUFFRCxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sU0FBUyxHQUFHO2dCQUNoQixLQUFLLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQztnQkFDckIsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUM7YUFDckIsQ0FBQTtZQUVELE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUU7Z0JBQ3pCLEtBQUssQ0FBQyxPQUFPLElBQUksYUFBYSxFQUFFO2dCQUNoQyxhQUFhLEVBQUU7Z0JBQ2YsY0FBYyxFQUFFO2FBQ2pCLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQgeyBoLCB3YXRjaCwgY29tcHV0ZWQsIGRlZmluZUNvbXBvbmVudCwgcmVmLCB1bnJlZiB9IGZyb20gJ3Z1ZSdcblxuLy8gRWZmZWN0c1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWNvbG9ycydcbi8vIGltcG9ydCB7IHVzZVRoZW1lIH0gZnJvbSAnLi4vLi4vZWZmZWN0cy91c2UtdGhlbWUnXG5cbi8vIENvbXBvbmVudHNcbmltcG9ydCB7IFZEYXRhVGFibGVIZWFkZXIgfSBmcm9tICcuL1ZEYXRhVGFibGVIZWFkZXInXG5pbXBvcnQgeyBWRGF0YVRhYmxlQm9keSB9IGZyb20gJy4vVkRhdGFUYWJsZUJvZHknXG5pbXBvcnQgeyBWRGF0YVRhYmxlRm9vdGVyIH0gZnJvbSAnLi9WRGF0YVRhYmxlRm9vdGVyJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQgeyBhZGRTY29wZWRTbG90IH0gZnJvbSAnLi4vLi4vaGVscGVycydcblxuLy8gVHlwZXNcbmltcG9ydCB7IFZOb2RlLCBQcm9wVHlwZSB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7XG4gIFRhYmxlQ29sdW1uLFxuICBUYWJsZUNvbHVtblByb3BzLFxuICBIZWFkZXJPcHRpb25zLFxuICBUYWJsZUZpbHRlcixcbn0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnXG5pbXBvcnQgeyBJRGF0YVRhYmxlRm9vdGVyT3B0aW9ucyB9IGZyb20gJ0AvY29tcG9uZW50cy9WRGF0YVRhYmxlL3R5cGVzJ1xuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1kYXRhLXRhYmxlJyxcbiAgcHJvcHM6IHtcbiAgICBjb2xzOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IFtdLFxuICAgIH0sXG4gICAgcm93czoge1xuICAgICAgdHlwZTogQXJyYXksXG4gICAgICBkZWZhdWx0OiAoKSA9PiBbXSxcbiAgICB9LFxuICAgIHNob3dTZXF1ZW5jZTogQm9vbGVhbixcbiAgICBzaG93Q2hlY2tib3g6IEJvb2xlYW4sXG4gICAgYWxpZ246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHZhbGlkYXRvcjogKHZhbCkgPT4gWydsZWZ0JywgJ2NlbnRlcicsICdyaWdodCddLmluY2x1ZGVzKHZhbCksXG4gICAgfSxcbiAgICBjb2xvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICBoZWFkZXJPcHRpb25zOiB7XG4gICAgICB0eXBlOiBPYmplY3QgYXMgUHJvcFR5cGU8SGVhZGVyT3B0aW9ucz4sXG4gICAgICBkZWZhdWx0OiAoKSA9PiAoe30pLFxuICAgIH0sXG4gICAgZm9vdGVyT3B0aW9uczoge1xuICAgICAgdHlwZTogT2JqZWN0IGFzIFByb3BUeXBlPElEYXRhVGFibGVGb290ZXJPcHRpb25zPixcbiAgICAgIGRlZmF1bHQ6IG51bGwsXG4gICAgfSxcbiAgICBjdXN0b21GaWx0ZXI6IEZ1bmN0aW9uLFxuICB9IGFzIGFueSxcblxuICBlbWl0czogW1xuICAgICdsYXN0LXBhZ2UnLFxuICAgICdzb3J0OmNvbHVtbicsXG4gICAgJ2ZpbHRlcjpjb2x1bW4nLFxuICAgICdzZWxlY3Q6cm93JyxcbiAgICAnY2xpY2s6cm93JyxcbiAgICAnZGJsY2xpY2s6cm93JyxcbiAgICAndXBkYXRlOnBhZ2UnLFxuICAgICd1cGRhdGU6cm93cycsXG4gICAgJ3VwZGF0ZTpyb3dzLWNvdW50JyxcbiAgICAnY29udGV4dG1lbnU6cm93JyxcbiAgXSxcblxuICBzZXR1cChwcm9wcywgeyBzbG90cywgZW1pdCB9KSB7XG4gICAgY29uc3QgY29scyA9IHJlZjxUYWJsZUNvbHVtbltdPihbXSlcbiAgICBjb25zdCByb3dzID0gcmVmPGFueVtdPihbXSlcbiAgICBjb25zdCBwYWdlID0gcmVmPG51bWJlcj4oMSlcbiAgICBjb25zdCByb3dzT25QYWdlID0gcmVmPG51bWJlcj4ocHJvcHMuZm9vdGVyT3B0aW9ucz8uY291bnRzPy5yb3dzUGVyUGFnZU9wdGlvbnM/LlswXSB8fCA1KVxuICAgIGNvbnN0IGNoZWNrZWRSb3dzID0gcmVmPGFueVtdPihbXSlcbiAgICBjb25zdCBpc0FsbFJvd3NDaGVja2VkID0gcmVmPGJvb2xlYW4+KGZhbHNlKVxuXG4gICAgY29uc3QgeyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IsIHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvciB9ID0gdXNlQ29sb3JzKClcblxuICAgIGNvbnN0IGZpbHRlcnMgPSB7fVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtZGF0YS10YWJsZSc6IHRydWUsXG4gICAgICAuLi4ocHJvcHMuY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IocHJvcHMuY29sb3IpIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQoKCkgPT4gKHtcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDc3NDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBoZWFkZXJPcHRpb25zID0gY29tcHV0ZWQ8SGVhZGVyT3B0aW9ucz4oKCkgPT4gKHtcbiAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAuLi5wcm9wcy5oZWFkZXJPcHRpb25zLFxuICAgIH0pKVxuXG4gICAgY29uc3QgZm9vdGVyT3B0aW9ucyA9IGNvbXB1dGVkPElEYXRhVGFibGVGb290ZXJPcHRpb25zPigoKSA9PiAoe1xuICAgICAgY29sb3I6IHByb3BzLmNvbG9yLFxuICAgICAgZGFyazogcHJvcHMuZGFyayxcbiAgICAgIC4uLnByb3BzLmZvb3Rlck9wdGlvbnMsXG4gICAgfSkpXG5cbiAgICBjb25zdCB0b3RhbFJvd3NDb3VudCA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy5mb290ZXJPcHRpb25zPy5jb3VudHM/LnRvdGFsUm93cyB8fCB1bnJlZihyb3dzKT8ubGVuZ3RoXG4gICAgfSlcblxuICAgIGNvbnN0IHBhZ2VzID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gTWF0aC5jZWlsKHVucmVmKHJvd3MpPy5sZW5ndGggLyB1bnJlZihyb3dzT25QYWdlKSlcbiAgICB9KVxuXG4gICAgY29uc3QgZmlyc3RPblBhZ2UgPSBjb21wdXRlZDxudW1iZXI+KCgpID0+IHtcbiAgICAgIHJldHVybiB1bnJlZihwYWdlKSA9PT0gMSA/IDEgOiAodW5yZWYocGFnZSkgLSAxKSAqIHVucmVmKHJvd3NPblBhZ2UpICsgMVxuICAgIH0pXG5cbiAgICBjb25zdCBsYXN0T25QYWdlID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gdW5yZWYocGFnZSkgKiB1bnJlZihyb3dzT25QYWdlKSA+IHVucmVmKHRvdGFsUm93c0NvdW50KVxuICAgICAgICA/IHVucmVmKHRvdGFsUm93c0NvdW50KVxuICAgICAgICA6IHVucmVmKHBhZ2UpICogdW5yZWYocm93c09uUGFnZSlcbiAgICB9KVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5jb2xzLFxuICAgICAgKG5ld0NvbHMpID0+IChjb2xzLnZhbHVlID0gbmV3Q29scyksXG4gICAgICB7IGltbWVkaWF0ZTogdHJ1ZSB9LFxuICAgIClcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gcHJvcHMucm93cyxcbiAgICAgIChuZXdSb3dzKSA9PiByb3dzLnZhbHVlID0gbmV3Um93cyxcbiAgICAgIHsgaW1tZWRpYXRlOiB0cnVlIH0sXG4gICAgKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5yb3dzLmxlbmd0aCxcbiAgICAgIChsZW5ndGgpID0+IGVtaXQoJ3VwZGF0ZTpyb3dzJywgeyBwYWdlLCBsZW5ndGggfSksXG4gICAgICB7IGltbWVkaWF0ZTogdHJ1ZSB9LFxuICAgIClcblxuICAgIGNvbnN0IG9uU2VsZWN0QWxsID0gKHZhbHVlOiBib29sZWFuKSA9PiB7XG4gICAgICBpc0FsbFJvd3NDaGVja2VkLnZhbHVlID0gdmFsdWVcbiAgICAgIHVucmVmKHJvd3MpLmZvckVhY2goKHJvdykgPT4gKHJvdy5jaGVja2VkID0gdmFsdWUpKVxuICAgIH1cblxuICAgIGNvbnN0IG9uU2VsZWN0ID0gKHJvd3M6IGFueVtdKSA9PiB7XG4gICAgICBjaGVja2VkUm93cy52YWx1ZSA9IHJvd3NcbiAgICAgIGVtaXQoJ3NlbGVjdDpyb3cnLCB1bnJlZihjaGVja2VkUm93cykpXG4gICAgfVxuXG4gICAgY29uc3Qgb25QcmV2UGFnZSA9IChudW06IG51bWJlcikgPT4ge1xuICAgICAgcGFnZS52YWx1ZSA9IHVucmVmKHBhZ2UpID4gMSA/IHVucmVmKHBhZ2UpICsgbnVtIDogdW5yZWYocGFnZSlcblxuICAgICAgZW1pdCgndXBkYXRlOnBhZ2UnLCB1bnJlZihwYWdlKSlcbiAgICB9XG5cbiAgICBjb25zdCBvbk5leHRQYWdlID0gKG51bTogbnVtYmVyKSA9PiB7XG4gICAgICBpZiAodW5yZWYodG90YWxSb3dzQ291bnQpIC0gdW5yZWYocGFnZSkgKiB1bnJlZihyb3dzT25QYWdlKSA+IDApIHtcbiAgICAgICAgcGFnZS52YWx1ZSArPSBudW1cbiAgICAgIH1cblxuICAgICAgZW1pdCgndXBkYXRlOnBhZ2UnLCB1bnJlZihwYWdlKSlcbiAgICB9XG5cbiAgICBjb25zdCBvblNvcnQgPSAoY29sOiBUYWJsZUNvbHVtbiAmIFRhYmxlQ29sdW1uUHJvcHMpID0+IHtcbiAgICAgIGlmIChjb2wuc29ydGVkKSB7XG4gICAgICAgIGNvbC5zb3J0ZWQgPSAhY29sLnNvcnRlZFxuXG4gICAgICAgIHJldHVybiBzb3J0Q29sdW1uKGNvbClcbiAgICAgIH1cblxuICAgICAgdW5yZWYoY29scykuZm9yRWFjaCgoYzogYW55KSA9PiAoYy5zb3J0ZWQgPSBjb2wua2V5ID09PSBjLmtleSkpXG5cbiAgICAgIHNvcnRDb2x1bW4oY29sKVxuICAgIH1cblxuICAgIGNvbnN0IHNvcnRDb2x1bW4gPSAoY29sOiBUYWJsZUNvbHVtbiAmIFRhYmxlQ29sdW1uUHJvcHMpID0+IHtcbiAgICAgIC8qKlxuICAgICAgICogaWYgZW1pdCBpcyBlcXVhbCB0cnVlXG4gICAgICAgKiBqdXN0IGVtaXQgdGhlIGV2ZW50XG4gICAgICAgKi9cbiAgICAgIGlmIChjb2wuZW1pdCkge1xuICAgICAgICByZXR1cm4gZW1pdCgnc29ydDpjb2x1bW4nLCBjb2wpXG4gICAgICB9XG5cbiAgICAgIGlmICghY29sLnNvcnRlZCkge1xuICAgICAgICByZXR1cm4gdW5yZWYocm93cyk/LnJldmVyc2UoKVxuICAgICAgfVxuXG4gICAgICBjb25zdCBleGVjdXRvciA9XG4gICAgICAgIGNvbC5zb3J0IHx8XG4gICAgICAgICgoYSwgYikgPT4ge1xuICAgICAgICAgIGlmIChjb2wuZm9ybWF0KSByZXR1cm4gY29sLmZvcm1hdChhKSA+IGNvbC5mb3JtYXQoYikgPyAxIDogLTFcbiAgICAgICAgICBpZiAoY29sLnNvcnRlZCkgcmV0dXJuIGFbY29sLmtleV0gPiBiW2NvbC5rZXldID8gMSA6IC0xXG4gICAgICAgIH0pXG5cbiAgICAgIHVucmVmKHJvd3MpPy5zb3J0KGV4ZWN1dG9yIGFzIGFueSlcbiAgICB9XG5cbiAgICBjb25zdCBvbkZpbHRlciA9ICh7IHZhbHVlLCBjb2wgfTogVGFibGVGaWx0ZXIpID0+IHtcbiAgICAgIGlmIChjb2wuZW1pdCkge1xuICAgICAgICByZXR1cm4gZW1pdCgnZmlsdGVyOmNvbHVtbicsIHsgdmFsdWUsIGNvbCB9KVxuICAgICAgfVxuXG4gICAgICBpZiAoIXZhbHVlICYmIGZpbHRlcnNbY29sLmtleV0pIHtcbiAgICAgICAgZGVsZXRlIGZpbHRlcnNbY29sLmtleV1cbiAgICAgIH1cblxuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIGZpbHRlcnNbY29sLmtleV0gPSB2YWx1ZVxuICAgICAgfVxuXG4gICAgICBpZiAoY29sLmZpbHRlcikge1xuICAgICAgICByZXR1cm4gKHJvd3MudmFsdWUgPSBjb2wuZmlsdGVyKHsgdmFsdWUsIGNvbCB9KSlcbiAgICAgIH1cblxuICAgICAgaWYgKHByb3BzLmN1c3RvbUZpbHRlcikge1xuICAgICAgICByZXR1cm4gcHJvcHMuY3VzdG9tRmlsdGVyKGZpbHRlcnMgYXMgYW55KVxuICAgICAgfVxuXG4gICAgICBpZiAoIU9iamVjdC5rZXlzKGZpbHRlcnMpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gKHJvd3MudmFsdWUgPSBwcm9wcy5yb3dzKVxuICAgICAgfVxuXG4gICAgICByb3dzLnZhbHVlID0gZmlsdGVyUm93cyhwcm9wcy5yb3dzLCBwcm9wcy5jb2xzKVxuICAgICAgcGFnZS52YWx1ZSA9IDFcbiAgICB9XG5cbiAgICBjb25zdCBvblNlbGVjdFJvd3NDb3VudCA9IChjb3VudDogbnVtYmVyKSA9PiB7XG4gICAgICByb3dzT25QYWdlLnZhbHVlID0gY291bnRcblxuICAgICAgZW1pdCgndXBkYXRlOnJvd3MtY291bnQnLCB1bnJlZihyb3dzT25QYWdlKSlcbiAgICB9XG5cbiAgICBjb25zdCBmaWx0ZXJSb3dzID0gPFQsIEMgZXh0ZW5kcyBUYWJsZUNvbHVtbj4ocm93czogVFtdLCBjb2xzOiBDW10pID0+IHtcbiAgICAgIGNvbnN0IGZpbHRlcktleXMgPSBPYmplY3Qua2V5cyhmaWx0ZXJzKVxuXG4gICAgICByZXR1cm4gcm93cy5yZWR1Y2UoKGFjYywgcm93KSA9PiB7XG4gICAgICAgIGNvbnN0IHJvd1Jlc3VsdHM6IFRbXSA9IFtdXG5cbiAgICAgICAgZmlsdGVyS2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGZvcm1hdCB9ID0gY29scy5maW5kKChjb2wpID0+IGNvbC5rZXkgPT09IGtleSkgYXMgVGFibGVDb2x1bW5cblxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gZm9ybWF0ID8gZm9ybWF0KHJvdykgOiByb3dba2V5XVxuXG4gICAgICAgICAgY29uc3Qgcm93S2V5VmFsdWUgPSBgJHsgdmFsdWUgfWAudG9Mb3dlckNhc2UoKVxuICAgICAgICAgIGNvbnN0IGZpbHRlclZhbHVlID0gYCR7IGZpbHRlcnNba2V5XSB9YC50b0xvd2VyQ2FzZSgpXG5cbiAgICAgICAgICBpZiAocm93S2V5VmFsdWUuaW5jbHVkZXMoZmlsdGVyVmFsdWUpKSB7XG4gICAgICAgICAgICByb3dSZXN1bHRzLnB1c2gocm93W2tleV0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICByb3dSZXN1bHRzLmxlbmd0aCA9PT0gZmlsdGVyS2V5cy5sZW5ndGggJiZcbiAgICAgICAgICByb3dSZXN1bHRzLmV2ZXJ5KCh2YWx1ZSkgPT4gISF2YWx1ZSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgYWNjLnB1c2gocm93KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwgW10gYXMgVFtdKVxuICAgIH1cblxuICAgIGNvbnN0IGdlblRhYmxlVG9vbHMgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0geyBjbGFzczogJ3YtZGF0YS10YWJsZV9fdG9vbGJhcicgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCB7XG4gICAgICAgIGRlZmF1bHQ6ICgpID0+IHNsb3RzLnRvb2xiYXIgJiYgc2xvdHMudG9vbGJhcigpLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZUhlYWRlciA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNvbHM6IHVucmVmKGNvbHMpLFxuICAgICAgICBjb2xvcjogcHJvcHMuY29sb3IsXG4gICAgICAgIHNob3dDaGVja2JveDogcHJvcHMuc2hvd0NoZWNrYm94LFxuICAgICAgICBkYXJrOiBwcm9wcy5kYXJrLFxuICAgICAgICBhbGlnbjogcHJvcHMuYWxpZ24sXG4gICAgICAgIHNob3dTZXF1ZW5jZTogcHJvcHMuc2hvd1NlcXVlbmNlLFxuICAgICAgICBvcHRpb25zOiB1bnJlZihoZWFkZXJPcHRpb25zKSxcbiAgICAgICAgb25GaWx0ZXIsXG4gICAgICAgIG9uU29ydCxcbiAgICAgICAgb25TZWxlY3RBbGwsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSB1bnJlZihjb2xzKS5yZWR1Y2UoKGFjYywgY29sKSA9PiB7XG4gICAgICAgIGNvbnN0IHNsb3ROYW1lID0gYCR7IGNvbC5rZXkgfS1maWx0ZXJgXG5cbiAgICAgICAgaWYgKGNvbCAmJiBzbG90c1tzbG90TmFtZV0pIHtcbiAgICAgICAgICBhY2Nbc2xvdE5hbWVdID0gYWRkU2NvcGVkU2xvdChzbG90TmFtZSwgc2xvdHMpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWNjXG4gICAgICB9LCB7fSBhcyBhbnkpXG5cbiAgICAgIGNvbnRlbnQuaGVhZGVyID0gYWRkU2NvcGVkU2xvdCgnaGVhZGVyJywgc2xvdHMpXG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVIZWFkZXIsIHByb3BzRGF0YSwgY29udGVudClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZUJvZHkgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjb2xzOiB1bnJlZihjb2xzKSxcbiAgICAgICAgcm93czogdW5yZWYocm93cyksXG4gICAgICAgIHBhZ2U6IHVucmVmKHBhZ2UpLFxuICAgICAgICByb3dzT25QYWdlOiB1bnJlZihyb3dzT25QYWdlKSxcbiAgICAgICAgY2hlY2tBbGxSb3dzOiB1bnJlZihpc0FsbFJvd3NDaGVja2VkKSxcbiAgICAgICAgc2hvd0NoZWNrYm94OiBwcm9wcy5zaG93Q2hlY2tib3gsXG4gICAgICAgIGFsaWduOiBwcm9wcy5hbGlnbixcbiAgICAgICAgZGFyazogcHJvcHMuZGFyayxcbiAgICAgICAgc2hvd1NlcXVlbmNlOiBwcm9wcy5zaG93U2VxdWVuY2UsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgICAgb25TZWxlY3QsXG4gICAgICAgIFsnb25DbGljazpyb3cnXTogKGUpID0+IGVtaXQoJ2NsaWNrOnJvdycsIGUpLFxuICAgICAgICBbJ29uRGJsY2xpY2s6cm93J106IChlKSA9PiBlbWl0KCdkYmxjbGljazpyb3cnLCBlKSxcbiAgICAgICAgWydvbkNvbnRleHRtZW51OnJvdyddOiAoZSkgPT4gZW1pdCgnY29udGV4dG1lbnU6cm93JywgZSksXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBwcm9wcy5jb2xzLnJlZHVjZSgoYWNjLCBjb2wpID0+IHtcbiAgICAgICAgaWYgKGNvbCAmJiBzbG90c1tjb2wua2V5XSkge1xuICAgICAgICAgIGFjY1tjb2wua2V5XSA9IGFkZFNjb3BlZFNsb3QoY29sLmtleSwgc2xvdHMpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwge30pXG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVCb2R5LCBwcm9wc0RhdGEsIGNvbnRlbnQpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuVGFibGVGb290ZXIgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBwYWdlczogdW5yZWYocGFnZXMpLFxuICAgICAgICBwYWdlOiB1bnJlZihwYWdlKSxcbiAgICAgICAgZmlyc3RPblBhZ2U6IHVucmVmKGZpcnN0T25QYWdlKSxcbiAgICAgICAgbGFzdE9uUGFnZTogdW5yZWYobGFzdE9uUGFnZSksXG4gICAgICAgIHJvd3NPblBhZ2U6IHVucmVmKHJvd3NPblBhZ2UpLFxuICAgICAgICByb3dzTGVuZ3RoOiB1bnJlZih0b3RhbFJvd3NDb3VudCksXG4gICAgICAgIG9wdGlvbnM6IHVucmVmKGZvb3Rlck9wdGlvbnMpLFxuICAgICAgICBvblByZXZQYWdlLFxuICAgICAgICBvbk5leHRQYWdlLFxuICAgICAgICBvblNlbGVjdFJvd3NDb3VudCxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udGVudCA9IHNsb3RzWydwYWdpbmF0aW9uLXRleHQnXVxuICAgICAgICA/IHtcbiAgICAgICAgICBbJ3BhZ2luYXRpb24tdGV4dCddOiAoKSA9PlxuICAgICAgICAgICAgc2xvdHNbJ3BhZ2luYXRpb24tdGV4dCddPy4oe1xuICAgICAgICAgICAgICBzdGFydDogdW5yZWYoZmlyc3RPblBhZ2UpLFxuICAgICAgICAgICAgICBsYXN0OiB1bnJlZihsYXN0T25QYWdlKSxcbiAgICAgICAgICAgICAgbGVuZ3RoOiB1bnJlZih0b3RhbFJvd3NDb3VudCksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfVxuICAgICAgICA6ICcnXG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVGb290ZXIsIHByb3BzRGF0YSwgY29udGVudClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZUlubmVyID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6ICd2LWRhdGEtdGFibGVfX2lubmVyJyxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHByb3BzRGF0YSwgW2dlblRhYmxlSGVhZGVyKCksIGdlblRhYmxlQm9keSgpXSlcbiAgICB9XG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGFzczogdW5yZWYoY2xhc3NlcyksXG4gICAgICAgIHN0eWxlOiB1bnJlZihzdHlsZXMpLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCBbXG4gICAgICAgIHNsb3RzLnRvb2xiYXIgJiYgZ2VuVGFibGVUb29scygpLFxuICAgICAgICBnZW5UYWJsZUlubmVyKCksXG4gICAgICAgIGdlblRhYmxlRm9vdGVyKCksXG4gICAgICBdKVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=