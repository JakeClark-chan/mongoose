import { h, computed, withDirectives, defineComponent } from 'vue';
import { useColors } from '../../composables/use-colors';
import { useIcons } from '../../composables/use-icons';
import { VIcon } from '../VIcon';
import { VCheckbox } from '../VCheckbox';
import { VDataTableCell } from './VDataTableCell';
import { VTextField } from '../VTextField';
import { vShow } from 'vue';
import { clickOutside } from '../../directives/v-click-outside';
import { useTransition } from '../../composables/use-transition';
import { transitions } from '../../services/transitions';
export const VDataTableHeader = defineComponent({
    name: 'v-data-table-header',
    props: {
        showSequence: Boolean,
        showCheckbox: Boolean,
        cols: Array,
        colWidth: {
            type: [String, Number],
            default: 125,
        },
        align: String,
        options: Object,
    },
    emits: ['sort', 'filter', 'select-all', 'update:cols'],
    setup(props, { emit, slots }) {
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { icons } = useIcons();
        const _cache = {};
        const classes = computed(() => ({
            'v-data-table__header': true,
            ...(props.options.color
                ? setBackgroundClassNameColor(props.options.color)
                : {}),
        }));
        const styles = computed(() => ({
            ...(props.options.color
                ? setBackgroundCssColor(props.options.color)
                : {}),
        }));
        const computedContentColor = computed(() => {
            return props.options.dark
                ? props.options?.contentColor || 'white'
                : props.options?.contentColor;
        });
        const cols = computed(() => [...props.cols]);
        const onSort = (col) => {
            emit('sort', col);
        };
        const onInput = ($value, col) => {
            col.filtered = !!$value;
            _cache[col.title] = $value;
            console.log(_cache);
            emit('filter', { value: $value, col });
        };
        const showFilter = (item) => {
            if (item.showFilter)
                return;
            item.showFilter = true;
        };
        const genSortButton = (col) => {
            const classes = {
                'v-data-table-col__actions-sort': true,
                'v-data-table-col__actions-sort--active': col.sorted,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$arrowUp,
                onClick: () => onSort(col),
            };
            return h(VIcon, propsData);
        };
        const genFilterButton = (col) => {
            const classes = {
                'v-data-table-col__actions-filter': true,
                'v-data-table-col__actions-filter--active': col.filtered,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$filter,
                color: !col.cellClass ? computedContentColor.value : '',
                onClick: () => showFilter(col),
            };
            return h(VIcon, propsData);
        };
        const genHeaderActions = (col) => {
            return h('span', { class: 'v-data-table-col__actions' }, [
                col.sortable && genSortButton(col),
                col.filterable && genFilterButton(col),
            ]);
        };
        const genFilterInput = (col) => {
            const propsData = {
                modelValue: _cache[col.title],
                label: 'search',
                dark: props.options.dark,
                color: !col.cellClass ? computedContentColor.value : '',
                prependIcon: icons.$search,
                clearable: true,
                onInput: ($value) => onInput($value, col),
            };
            return h(VTextField, propsData);
        };
        const genFilterWrapper = (col) => {
            const color = props.options.dark
                ? props.options?.color || 'grey darken-3'
                : props.options?.color || 'white';
            const slotName = `${col.key}-filter`;
            const filterSlot = slots[slotName] && slots[slotName]({
                filter: (event) => onInput(event, col),
            });
            const directive = col.showFilter
                ? {
                    handler: () => setTimeout(() => (col.showFilter = false)),
                    closeConditional: false,
                }
                : undefined;
            const propsData = {
                class: {
                    'v-data-table-col__filter': !filterSlot,
                    'v-data-table-col__custom-filter': !!filterSlot,
                    'elevation-5': true,
                    [col.cellClass]: !!col.cellClass,
                    ...(color ? setBackgroundClassNameColor(color) : {}),
                },
                style: {
                    ...(color ? setBackgroundCssColor(color) : {}),
                },
            };
            return (col.filterable &&
                withDirectives(h('div', propsData, filterSlot || genFilterInput(col)), [
                    [clickOutside, directive],
                    [vShow, col.showFilter],
                ]));
        };
        const genHeaderTitle = (col) => {
            return h('div', { class: 'v-data-table-col__title' }, col.title);
        };
        const genNumberCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__number': true,
                    [props.cellClass]: !!props.cellClass,
                },
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            return h(VDataTableCell, propsData, { default: () => 'â„–' });
        };
        const genCheckboxCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__checkbox': true,
                    [props.cellClass]: !!props.cellClass,
                },
                dark: props.options.dark,
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            const content = {
                default: () => h(VCheckbox, {
                    color: computedContentColor.value,
                    onChange: (e) => emit('select-all', e),
                }),
            };
            return h(VDataTableCell, propsData, content);
        };
        const genHeaderCell = (col) => {
            const propsData = {
                dark: props.options.dark,
                class: {
                    'v-data-table-col': true,
                    'v-data-table-col--sorted': col.sorted,
                    [col.cellClass]: !!col.cellClass,
                },
                contentColor: !col.cellClass ? computedContentColor.value : '',
                color: !col.cellClass ? props.options.color : '',
                width: col.width,
                resizeable: col.resizeable,
                resizerColor: props.options?.resizerColor,
                align: col.align || props.align,
                onResize: ($size) => (col.width = $size),
            };
            return h(VDataTableCell, propsData, {
                default: () => [
                    genHeaderTitle(col),
                    genHeaderActions(col),
                    useTransition(genFilterWrapper(col), transitions.FADE),
                ],
            });
        };
        const genHeaderChildren = () => {
            const children = [];
            const headerSlot = slots.header && slots.header(props);
            props.showSequence && children.push(genNumberCell());
            props.showCheckbox && children.push(genCheckboxCell());
            cols.value.forEach((col) => {
                col.width = col.width || props.colWidth;
                if (!col.hasOwnProperty('show')) {
                    col.show = !col.show;
                }
                !headerSlot[0].children &&
                    col.show &&
                    children.push(genHeaderCell(col));
            });
            headerSlot[0].children && children.push(headerSlot);
            return children;
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, genHeaderChildren());
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZUhlYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3Z1ZWxhbmQvc3JjL2NvbXBvbmVudHMvVkRhdGFUYWJsZS9WRGF0YVRhYmxlSGVhZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFHbEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQUd0RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ2hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFHMUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEtBQUssQ0FBQTtBQUMzQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFLL0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUV4RCxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7SUFDOUMsSUFBSSxFQUFFLHFCQUFxQjtJQUUzQixLQUFLLEVBQUU7UUFDTCxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsT0FBTztRQUNyQixJQUFJLEVBQUUsS0FBSztRQUNYLFFBQVEsRUFBRTtZQUNSLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLEdBQUc7U0FDYjtRQUNELEtB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QUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQgeyBoLCBjb21wdXRlZCwgd2l0aERpcmVjdGl2ZXMsIGRlZmluZUNvbXBvbmVudCB9IGZyb20gJ3Z1ZSdcblxuLy8gRWZmZWN0c1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWNvbG9ycydcbmltcG9ydCB7IHVzZUljb25zIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWljb25zJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgeyBWSWNvbiB9IGZyb20gJy4uL1ZJY29uJ1xuaW1wb3J0IHsgVkNoZWNrYm94IH0gZnJvbSAnLi4vVkNoZWNrYm94J1xuaW1wb3J0IHsgVkRhdGFUYWJsZUNlbGwgfSBmcm9tICcuL1ZEYXRhVGFibGVDZWxsJ1xuaW1wb3J0IHsgVlRleHRGaWVsZCB9IGZyb20gJy4uL1ZUZXh0RmllbGQnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCB7IHZTaG93IH0gZnJvbSAndnVlJ1xuaW1wb3J0IHsgY2xpY2tPdXRzaWRlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy92LWNsaWNrLW91dHNpZGUnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7IFRhYmxlQ29sdW1uIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnXG5pbXBvcnQgeyB1c2VUcmFuc2l0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXRyYW5zaXRpb24nXG5pbXBvcnQgeyB0cmFuc2l0aW9ucyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RyYW5zaXRpb25zJ1xuXG5leHBvcnQgY29uc3QgVkRhdGFUYWJsZUhlYWRlciA9IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LWRhdGEtdGFibGUtaGVhZGVyJyxcblxuICBwcm9wczoge1xuICAgIHNob3dTZXF1ZW5jZTogQm9vbGVhbixcbiAgICBzaG93Q2hlY2tib3g6IEJvb2xlYW4sXG4gICAgY29sczogQXJyYXksXG4gICAgY29sV2lkdGg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAxMjUsXG4gICAgfSxcbiAgICBhbGlnbjogU3RyaW5nLFxuICAgIG9wdGlvbnM6IE9iamVjdCxcbiAgfSBhcyBhbnksXG5cbiAgZW1pdHM6IFsnc29ydCcsICdmaWx0ZXInLCAnc2VsZWN0LWFsbCcsICd1cGRhdGU6Y29scyddLFxuXG4gIHNldHVwKHByb3BzLCB7IGVtaXQsIHNsb3RzIH0pIHtcbiAgICBjb25zdCB7IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvciwgc2V0QmFja2dyb3VuZENzc0NvbG9yIH0gPSB1c2VDb2xvcnMoKVxuICAgIGNvbnN0IHsgaWNvbnMgfSA9IHVzZUljb25zKClcbiAgICBjb25zdCBfY2FjaGUgPSB7fVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtZGF0YS10YWJsZV9faGVhZGVyJzogdHJ1ZSxcbiAgICAgIC4uLihwcm9wcy5vcHRpb25zLmNvbG9yXG4gICAgICAgID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKHByb3BzLm9wdGlvbnMuY29sb3IpXG4gICAgICAgIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQoKCkgPT4gKHtcbiAgICAgIC4uLihwcm9wcy5vcHRpb25zLmNvbG9yXG4gICAgICAgID8gc2V0QmFja2dyb3VuZENzc0NvbG9yKHByb3BzLm9wdGlvbnMuY29sb3IpXG4gICAgICAgIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3QgY29tcHV0ZWRDb250ZW50Q29sb3IgPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy5vcHRpb25zLmRhcmtcbiAgICAgICAgPyBwcm9wcy5vcHRpb25zPy5jb250ZW50Q29sb3IgfHwgJ3doaXRlJ1xuICAgICAgICA6IHByb3BzLm9wdGlvbnM/LmNvbnRlbnRDb2xvclxuICAgIH0pXG5cbiAgICBjb25zdCBjb2xzID0gY29tcHV0ZWQ8VGFibGVDb2x1bW5bXT4oKCkgPT4gWy4uLnByb3BzLmNvbHNdKVxuXG4gICAgY29uc3Qgb25Tb3J0ID0gKGNvbCkgPT4ge1xuICAgICAgZW1pdCgnc29ydCcsIGNvbClcbiAgICB9XG5cbiAgICBjb25zdCBvbklucHV0ID0gKCR2YWx1ZSwgY29sKSA9PiB7XG4gICAgICBjb2wuZmlsdGVyZWQgPSAhISR2YWx1ZVxuICAgICAgX2NhY2hlW2NvbC50aXRsZV0gPSAkdmFsdWVcbiAgICAgIGNvbnNvbGUubG9nKF9jYWNoZSlcbiAgICAgIGVtaXQoJ2ZpbHRlcicsIHsgdmFsdWU6ICR2YWx1ZSwgY29sIH0pXG4gICAgfVxuXG4gICAgY29uc3Qgc2hvd0ZpbHRlciA9IChpdGVtKSA9PiB7XG4gICAgICBpZiAoaXRlbS5zaG93RmlsdGVyKSByZXR1cm5cbiAgICAgIGl0ZW0uc2hvd0ZpbHRlciA9IHRydWVcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Tb3J0QnV0dG9uID0gKGNvbCkgPT4ge1xuICAgICAgY29uc3QgY2xhc3NlcyA9IHtcbiAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMtc29ydCc6IHRydWUsXG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLXNvcnQtLWFjdGl2ZSc6IGNvbC5zb3J0ZWQsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xpY2thYmxlOiB0cnVlLFxuICAgICAgICBjbGFzczogY2xhc3NlcyxcbiAgICAgICAgaWNvbjogaWNvbnMuJGFycm93VXAsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IG9uU29ydChjb2wpLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWSWNvbiwgcHJvcHNEYXRhKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkZpbHRlckJ1dHRvbiA9IChjb2wpID0+IHtcbiAgICAgIGNvbnN0IGNsYXNzZXMgPSB7XG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLWZpbHRlcic6IHRydWUsXG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLWZpbHRlci0tYWN0aXZlJzogY29sLmZpbHRlcmVkLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsaWNrYWJsZTogdHJ1ZSxcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMsXG4gICAgICAgIGljb246IGljb25zLiRmaWx0ZXIsXG4gICAgICAgIGNvbG9yOiAhY29sLmNlbGxDbGFzcyA/IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlIDogJycsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IHNob3dGaWx0ZXIoY29sKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkljb24sIHByb3BzRGF0YSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJBY3Rpb25zID0gKGNvbCkgPT4ge1xuICAgICAgcmV0dXJuIGgoJ3NwYW4nLCB7IGNsYXNzOiAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucycgfSwgW1xuICAgICAgICBjb2wuc29ydGFibGUgJiYgZ2VuU29ydEJ1dHRvbihjb2wpLFxuICAgICAgICBjb2wuZmlsdGVyYWJsZSAmJiBnZW5GaWx0ZXJCdXR0b24oY29sKSxcbiAgICAgIF0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuRmlsdGVySW5wdXQgPSAoY29sKSA9PiB7XG4gICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBtb2RlbFZhbHVlOiBfY2FjaGVbY29sLnRpdGxlXSxcbiAgICAgICAgbGFiZWw6ICdzZWFyY2gnLFxuICAgICAgICBkYXJrOiBwcm9wcy5vcHRpb25zLmRhcmssXG4gICAgICAgIGNvbG9yOiAhY29sLmNlbGxDbGFzcyA/IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlIDogJycsXG4gICAgICAgIHByZXBlbmRJY29uOiBpY29ucy4kc2VhcmNoLFxuICAgICAgICBjbGVhcmFibGU6IHRydWUsXG4gICAgICAgIG9uSW5wdXQ6ICgkdmFsdWUpID0+IG9uSW5wdXQoJHZhbHVlLCBjb2wpLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWVGV4dEZpZWxkLCBwcm9wc0RhdGEpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuRmlsdGVyV3JhcHBlciA9IChjb2wpID0+IHtcbiAgICAgIGNvbnN0IGNvbG9yID0gcHJvcHMub3B0aW9ucy5kYXJrXG4gICAgICAgID8gcHJvcHMub3B0aW9ucz8uY29sb3IgfHwgJ2dyZXkgZGFya2VuLTMnXG4gICAgICAgIDogcHJvcHMub3B0aW9ucz8uY29sb3IgfHwgJ3doaXRlJ1xuXG4gICAgICBjb25zdCBzbG90TmFtZSA9IGAkeyBjb2wua2V5IH0tZmlsdGVyYFxuXG4gICAgICBjb25zdCBmaWx0ZXJTbG90ID0gc2xvdHNbc2xvdE5hbWVdICYmIHNsb3RzW3Nsb3ROYW1lXSEoe1xuICAgICAgICBmaWx0ZXI6IChldmVudCkgPT4gb25JbnB1dChldmVudCwgY29sKSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IGRpcmVjdGl2ZSA9IGNvbC5zaG93RmlsdGVyXG4gICAgICAgID8ge1xuICAgICAgICAgIGhhbmRsZXI6ICgpID0+IHNldFRpbWVvdXQoKCkgPT4gKGNvbC5zaG93RmlsdGVyID0gZmFsc2UpKSxcbiAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBmYWxzZSxcbiAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZFxuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2ZpbHRlcic6ICFmaWx0ZXJTbG90LFxuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sX19jdXN0b20tZmlsdGVyJzogISFmaWx0ZXJTbG90LFxuICAgICAgICAgICdlbGV2YXRpb24tNSc6IHRydWUsXG4gICAgICAgICAgW2NvbC5jZWxsQ2xhc3NdOiAhIWNvbC5jZWxsQ2xhc3MsXG4gICAgICAgICAgLi4uKGNvbG9yID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKGNvbG9yKSA6IHt9KSxcbiAgICAgICAgfSxcbiAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAuLi4oY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IoY29sb3IpIDoge30pLFxuICAgICAgICB9LFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICBjb2wuZmlsdGVyYWJsZSAmJlxuICAgICAgICB3aXRoRGlyZWN0aXZlcyhoKCdkaXYnLCBwcm9wc0RhdGEsIGZpbHRlclNsb3QgfHwgZ2VuRmlsdGVySW5wdXQoY29sKSksIFtcbiAgICAgICAgICBbY2xpY2tPdXRzaWRlLCBkaXJlY3RpdmVdLFxuICAgICAgICAgIFt2U2hvdywgY29sLnNob3dGaWx0ZXJdLFxuICAgICAgICBdKVxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkhlYWRlclRpdGxlID0gKGNvbCk6IFZOb2RlID0+IHtcbiAgICAgIHJldHVybiBoKCdkaXYnLCB7IGNsYXNzOiAndi1kYXRhLXRhYmxlLWNvbF9fdGl0bGUnIH0sIGNvbC50aXRsZSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5OdW1iZXJDZWxsID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgYWxpZ246ICdjZW50ZXInLFxuICAgICAgICBjbGFzczoge1xuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sX19udW1iZXInOiB0cnVlLFxuICAgICAgICAgIFtwcm9wcy5jZWxsQ2xhc3NdOiAhIXByb3BzLmNlbGxDbGFzcyxcbiAgICAgICAgfSxcbiAgICAgICAgY29udGVudENvbG9yOiBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSxcbiAgICAgICAgY29sb3I6IHByb3BzLm9wdGlvbnMuY29sb3IsXG4gICAgICAgIHdpZHRoOiA1MCxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUNlbGwsIHByb3BzRGF0YSwgeyBkZWZhdWx0OiAoKSA9PiAn4oSWJyB9KVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkNoZWNrYm94Q2VsbCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgYWxpZ246ICdjZW50ZXInLFxuICAgICAgICBjbGFzczoge1xuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sX19jaGVja2JveCc6IHRydWUsXG4gICAgICAgICAgW3Byb3BzLmNlbGxDbGFzc106ICEhcHJvcHMuY2VsbENsYXNzLFxuICAgICAgICB9LFxuICAgICAgICBkYXJrOiBwcm9wcy5vcHRpb25zLmRhcmssXG4gICAgICAgIGNvbnRlbnRDb2xvcjogY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5vcHRpb25zLmNvbG9yLFxuICAgICAgICB3aWR0aDogNTAsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSB7XG4gICAgICAgIGRlZmF1bHQ6ICgpID0+XG4gICAgICAgICAgaChWQ2hlY2tib3gsIHtcbiAgICAgICAgICAgIGNvbG9yOiBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSxcbiAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gZW1pdCgnc2VsZWN0LWFsbCcsIGUpLFxuICAgICAgICAgIH0pLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlQ2VsbCwgcHJvcHNEYXRhLCBjb250ZW50KVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkhlYWRlckNlbGwgPSAoY29sKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGRhcms6IHByb3BzLm9wdGlvbnMuZGFyayxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbCc6IHRydWUsXG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2wtLXNvcnRlZCc6IGNvbC5zb3J0ZWQsXG4gICAgICAgICAgW2NvbC5jZWxsQ2xhc3NdOiAhIWNvbC5jZWxsQ2xhc3MsXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRDb2xvcjogIWNvbC5jZWxsQ2xhc3MgPyBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSA6ICcnLFxuICAgICAgICBjb2xvcjogIWNvbC5jZWxsQ2xhc3MgPyBwcm9wcy5vcHRpb25zLmNvbG9yIDogJycsXG4gICAgICAgIHdpZHRoOiBjb2wud2lkdGgsXG4gICAgICAgIHJlc2l6ZWFibGU6IGNvbC5yZXNpemVhYmxlLFxuICAgICAgICByZXNpemVyQ29sb3I6IHByb3BzLm9wdGlvbnM/LnJlc2l6ZXJDb2xvcixcbiAgICAgICAgYWxpZ246IGNvbC5hbGlnbiB8fCBwcm9wcy5hbGlnbixcbiAgICAgICAgb25SZXNpemU6ICgkc2l6ZSkgPT4gKGNvbC53aWR0aCA9ICRzaXplKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUNlbGwsIHByb3BzRGF0YSwge1xuICAgICAgICBkZWZhdWx0OiAoKSA9PiBbXG4gICAgICAgICAgZ2VuSGVhZGVyVGl0bGUoY29sKSxcbiAgICAgICAgICBnZW5IZWFkZXJBY3Rpb25zKGNvbCksXG4gICAgICAgICAgdXNlVHJhbnNpdGlvbihnZW5GaWx0ZXJXcmFwcGVyKGNvbCksIHRyYW5zaXRpb25zLkZBREUpLFxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJDaGlsZHJlbiA9ICgpID0+IHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuOiBWTm9kZVtdID0gW11cbiAgICAgIGNvbnN0IGhlYWRlclNsb3QgPSBzbG90cy5oZWFkZXIgJiYgc2xvdHMuaGVhZGVyKHByb3BzKVxuXG4gICAgICBwcm9wcy5zaG93U2VxdWVuY2UgJiYgY2hpbGRyZW4ucHVzaChnZW5OdW1iZXJDZWxsKCkpXG4gICAgICBwcm9wcy5zaG93Q2hlY2tib3ggJiYgY2hpbGRyZW4ucHVzaChnZW5DaGVja2JveENlbGwoKSlcblxuICAgICAgY29scy52YWx1ZSEuZm9yRWFjaCgoY29sOiBUYWJsZUNvbHVtbikgPT4ge1xuICAgICAgICBjb2wud2lkdGggPSBjb2wud2lkdGggfHwgcHJvcHMuY29sV2lkdGhcblxuICAgICAgICBpZiAoIWNvbC5oYXNPd25Qcm9wZXJ0eSgnc2hvdycpKSB7XG4gICAgICAgICAgY29sLnNob3cgPSAhY29sLnNob3dcbiAgICAgICAgfVxuXG4gICAgICAgICFoZWFkZXJTbG90IVswXS5jaGlsZHJlbiAmJlxuICAgICAgICBjb2wuc2hvdyAmJlxuICAgICAgICBjaGlsZHJlbi5wdXNoKGdlbkhlYWRlckNlbGwoY29sKSlcbiAgICAgIH0pXG5cbiAgICAgIGhlYWRlclNsb3QhWzBdLmNoaWxkcmVuICYmIGNoaWxkcmVuLnB1c2goaGVhZGVyU2xvdCBhcyBhbnkpXG5cbiAgICAgIHJldHVybiBjaGlsZHJlblxuICAgIH1cblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogc3R5bGVzLnZhbHVlLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCBnZW5IZWFkZXJDaGlsZHJlbigpKVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=