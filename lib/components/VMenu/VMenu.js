import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, unref, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composables/use-auto-position';
import { activatorProps, useActivator } from '../../composables/use-activator';
import { useDetach } from '../../composables/use-detach';
import { useElevation } from '../../composables/use-elevation';
import { useToggle } from '../../composables/use-toggle';
import { useTransition } from '../../composables/use-transition';
import { positionProps } from '../../composables/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export default defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return unref(isActive)
                ? {
                    handler: (e) => {
                        if (props.internalActivator &&
                            unref(activatorRef).contains(e.target)) {
                            return;
                        }
                        isActive.value = false;
                    },
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (state) => {
            state && emit('show');
            !state && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(unref(activatorRef)));
        watch(() => props.modelValue, (state) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = state));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...unref(elevationClasses),
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!unref(isActive)) {
                return;
            }
            requestAnimationFrame(() => setDimensions(unref(activatorRef)));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: unref(contentClasses),
                style: unref(contentStyles),
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(unref(calcWidth)),
                },
            }, [slots.default?.()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, unref(isActive)],
                [resize, onResize],
                [clickOutside, unref(directive)],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(unref(contentRef));
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy92dWVsYW5kL3NyYy9jb21wb25lbnRzL1ZNZW51L1ZNZW51LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxlQUFlLEVBQ2YsS0FBSyxFQUNMLENBQUMsRUFDRCxjQUFjLEVBQ2QsUUFBUSxFQUNSLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxFQUNMLEtBQUssR0FHTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZUFBZSxHQUNoQixNQUFNLHFDQUFxQyxDQUFBO0FBQzVDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDOUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUM5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUc5RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFdkQsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLFFBQVE7SUFDZCxVQUFVLEVBQUU7UUFDVixZQUFZO1FBQ1osTUFBTTtLQUNQO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsR0FBRztTQUNiO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLENBQUMs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UUFFRCxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ2IsWUFBWSxDQUFDLEtBQUssR0FBRyxZQUFZLEVBQUUsQ0FBQTtZQUVuQyxrQkFBa0IsRUFBRSxDQUFBO1lBQ3BCLFdBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFFLENBQUMsQ0FBQTtRQUNqQyxDQUFDLENBQUMsQ0FBQTtRQUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIscUJBQXFCLEVBQUUsQ0FBQTtZQUN2QixjQUFjLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNYLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN2QyxLQUFLLENBQUMsU0FBUyxJQUFJLGdCQUFnQixFQUFFO1lBQ3JDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLENBQUM7U0FDeEMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQge1xuICBkZWZpbmVDb21wb25lbnQsXG4gIHdhdGNoLFxuICBoLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgY29tcHV0ZWQsXG4gIG9uTW91bnRlZCxcbiAgb25CZWZvcmVVbm1vdW50LFxuICB1bnJlZixcbiAgdlNob3csXG4gIFZOb2RlLFxuICBEaXJlY3RpdmVBcmd1bWVudHMsXG59IGZyb20gJ3Z1ZSdcblxuLy8gQ29tcG9zYWJsZVxuaW1wb3J0IHtcbiAgYXV0b1Bvc2l0aW9uUHJvcHMsXG4gIHVzZUF1dG9Qb3NpdGlvbixcbn0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWF1dG8tcG9zaXRpb24nXG5pbXBvcnQgeyBhY3RpdmF0b3JQcm9wcywgdXNlQWN0aXZhdG9yIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWFjdGl2YXRvcidcbmltcG9ydCB7IHVzZURldGFjaCB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1kZXRhY2gnXG5pbXBvcnQgeyB1c2VFbGV2YXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtZWxldmF0aW9uJ1xuaW1wb3J0IHsgdXNlVG9nZ2xlIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXRvZ2dsZSdcbmltcG9ydCB7IHVzZVRyYW5zaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtdHJhbnNpdGlvbidcbmltcG9ydCB7IHBvc2l0aW9uUHJvcHMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtcG9zaXRpb24nXG5cbi8vIEhlbHBlcnNcbmltcG9ydCB7IGNvbnZlcnRUb1VuaXQgfSBmcm9tICcuLi8uLi9oZWxwZXJzJ1xuXG4vLyBEaXJlY3RpdmVzXG5pbXBvcnQgeyBjbGlja091dHNpZGUsIHJlc2l6ZSB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMnXG5cbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LW1lbnUnLFxuICBkaXJlY3RpdmVzOiB7XG4gICAgY2xpY2tPdXRzaWRlLFxuICAgIHJlc2l6ZSxcbiAgfSxcbiAgcHJvcHM6IHtcbiAgICBtYXhIZWlnaHQ6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAyMDAsXG4gICAgfSxcbiAgICB3aWR0aDoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDAsXG4gICAgfSxcbiAgICB6SW5kZXg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAxMCxcbiAgICB9LFxuICAgIG9wZW5PbkhvdmVyOiBCb29sZWFuLFxuICAgIG9wZW5PbkNsaWNrOiBCb29sZWFuLFxuICAgIG9wZW5PbkNvbnRleHRtZW51OiBCb29sZWFuLFxuICAgIGNsb3NlT25DbGljazoge1xuICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgfSxcbiAgICBlbGV2YXRpb246IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAxMCxcbiAgICB9LFxuICAgIG9mZnNldFg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIG9mZnNldFk6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIG1vZGVsVmFsdWU6IEJvb2xlYW4sXG4gICAgaW5wdXRBY3RpdmF0b3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICcnLFxuICAgIH0sXG4gICAgLi4ucG9zaXRpb25Qcm9wcygpLFxuICAgIC4uLmF1dG9Qb3NpdGlvblByb3BzKCksXG4gICAgLi4uYWN0aXZhdG9yUHJvcHMoKSxcbiAgfSxcblxuICBlbWl0czogWydzaG93JywgJ2hpZGUnXSxcblxuICBzZXR1cChwcm9wcywgeyBlbWl0LCBzbG90cyB9KSB7XG4gICAgY29uc3QgeyBlbGV2YXRpb25DbGFzc2VzIH0gPSB1c2VFbGV2YXRpb24ocHJvcHMpXG4gICAgY29uc3QgeyBpc0FjdGl2ZSB9ID0gdXNlVG9nZ2xlKHByb3BzKVxuICAgIGNvbnN0IHsgY29udGVudFJlZiwgc2V0RGltZW5zaW9ucywgZGltZW5zaW9ucyB9ID0gdXNlQXV0b1Bvc2l0aW9uKHByb3BzKVxuICAgIGNvbnN0IHsgc2V0RGV0YWNoZWQsIHJlbW92ZURldGFjaGVkIH0gPSB1c2VEZXRhY2goKVxuICAgIGNvbnN0IHtcbiAgICAgIGFjdGl2YXRvclJlZixcbiAgICAgIGdldEFjdGl2YXRvcixcbiAgICAgIGdlbkFjdGl2YXRvckxpc3RlbmVycyxcbiAgICAgIGFkZEFjdGl2YXRvckV2ZW50cyxcbiAgICAgIHJlbW92ZUFjdGl2YXRvckV2ZW50cyxcbiAgICB9ID0gdXNlQWN0aXZhdG9yKHByb3BzKVxuXG4gICAgY29uc3Qgc2V0RGltZW5zaW9uc09uID0gKGUsIGZsYWcpID0+IHtcbiAgICAgIHNldERpbWVuc2lvbnMoZ2V0QWN0aXZhdG9yKGUpISkudGhlbigoKSA9PiB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSBmbGFnKSlcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XG4gICAgICBjbGljazogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25DbGljayksXG4gICAgICBtb3VzZWVudGVyOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkhvdmVyKSxcbiAgICAgIG1vdXNlbGVhdmU6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgIXByb3BzLm9wZW5PbkhvdmVyKSxcbiAgICAgIGNvbnRleHRtZW51OiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkNvbnRleHRtZW51KSxcbiAgICB9XG5cbiAgICBjb25zdCBsaXN0ZW5lcnMgPSBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMocHJvcHMsIGhhbmRsZXJzKVxuXG4gICAgY29uc3QgZGlyZWN0aXZlID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgICAgcmV0dXJuIHVucmVmKGlzQWN0aXZlKVxuICAgICAgICA/IHtcbiAgICAgICAgICBoYW5kbGVyOiAoZSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBwcm9wcy5pbnRlcm5hbEFjdGl2YXRvciAmJlxuICAgICAgICAgICAgICB1bnJlZihhY3RpdmF0b3JSZWYpLmNvbnRhaW5zKGUudGFyZ2V0KVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBwcm9wcy5jbG9zZU9uQ2xpY2ssXG4gICAgICAgIH1cbiAgICAgICAgOiB1bmRlZmluZWRcbiAgICB9KVxuXG4gICAgY29uc3QgY2FsY1dpZHRoID0gY29tcHV0ZWQ8bnVtYmVyIHwgc3RyaW5nPigoKSA9PiB7XG4gICAgICByZXR1cm4gcHJvcHMud2lkdGggfHwgK2RpbWVuc2lvbnMuY29udGVudC53aWR0aFxuICAgIH0pXG5cbiAgICB3YXRjaChpc0FjdGl2ZSwgKHN0YXRlKSA9PiB7XG4gICAgICBzdGF0ZSAmJiBlbWl0KCdzaG93JylcbiAgICAgICFzdGF0ZSAmJiBlbWl0KCdoaWRlJylcbiAgICB9KVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBbcHJvcHMucG9zaXRpb25ZLCBwcm9wcy5wb3NpdGlvblhdLFxuICAgICAgKCkgPT4gc2V0RGltZW5zaW9ucyh1bnJlZihhY3RpdmF0b3JSZWYpKSxcbiAgICApXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IHByb3BzLm1vZGVsVmFsdWUsXG4gICAgICAoc3RhdGUpID0+IHtcbiAgICAgICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZVxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IHN0YXRlKSlcbiAgICAgIH0sXG4gICAgKVxuXG4gICAgY29uc3QgY29udGVudENsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LW1lbnVfX2NvbnRlbnQnOiB0cnVlLFxuICAgICAgLi4udW5yZWYoZWxldmF0aW9uQ2xhc3NlcyksXG4gICAgfSkpXG5cbiAgICBjb25zdCBjb250ZW50U3R5bGVzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyPj4oKCkgPT4gKHtcbiAgICAgIHRvcDogY29udmVydFRvVW5pdChkaW1lbnNpb25zLmNvbnRlbnQudG9wKSEsXG4gICAgICBsZWZ0OiBjb252ZXJ0VG9Vbml0KGRpbWVuc2lvbnMuY29udGVudC5sZWZ0KSEsXG4gICAgICB6SW5kZXg6IHByb3BzLnpJbmRleCxcbiAgICB9KSkgYXMgYW55XG5cbiAgICBjb25zdCBvbkNvbnRlbnRDbGljayA9ICgpID0+IHtcbiAgICAgIGlzQWN0aXZlLnZhbHVlID0gIXByb3BzLmNsb3NlT25DbGlja1xuICAgIH1cblxuICAgIGNvbnN0IG9uUmVzaXplID0gKCkgPT4ge1xuICAgICAgaWYgKCF1bnJlZihpc0FjdGl2ZSkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBzZXREaW1lbnNpb25zKHVucmVmKGFjdGl2YXRvclJlZikpKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkFjdGl2YXRvclNsb3QgPSAoKTogTWF5YmU8Vk5vZGU+ID0+IHtcbiAgICAgIGlmIChzbG90cy5hY3RpdmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBzbG90cy5hY3RpdmF0b3IoeyBvbjogbGlzdGVuZXJzIH0pXG5cbiAgICAgICAgaWYgKHR5cGVvZiBzbG90Q29udGVudCFbMF0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICByZXR1cm4gaCgnZGl2JywgeyByZWY6IGFjdGl2YXRvclJlZiB9LCBoKHNsb3RDb250ZW50IVswXSkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaChzbG90Q29udGVudCFbMF0sIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Db250ZW50U2xvdCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIHJlZjogY29udGVudFJlZixcbiAgICAgICAgY2xhc3M6IHVucmVmKGNvbnRlbnRDbGFzc2VzKSxcbiAgICAgICAgc3R5bGU6IHVucmVmKGNvbnRlbnRTdHlsZXMpLFxuICAgICAgICBvbkNsaWNrOiBvbkNvbnRlbnRDbGljayxcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBoKFxuICAgICAgICAnZGl2JyxcbiAgICAgICAge1xuICAgICAgICAgIGNsYXNzOiAndi1tZW51X19zbG90JyxcbiAgICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgbWF4SGVpZ2h0OiBjb252ZXJ0VG9Vbml0KHByb3BzLm1heEhlaWdodCksXG4gICAgICAgICAgICB3aWR0aDogY29udmVydFRvVW5pdCh1bnJlZihjYWxjV2lkdGgpKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBbc2xvdHMuZGVmYXVsdD8uKCldLFxuICAgICAgKVxuXG4gICAgICBjb25zdCBjb250ZW50ID0gaCgnZGl2JywgcHJvcHNEYXRhLCBzbG90Q29udGVudClcblxuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlQXJndW1lbnRzID0gW1xuICAgICAgICBbdlNob3csIHVucmVmKGlzQWN0aXZlKV0sXG4gICAgICAgIFtyZXNpemUsIG9uUmVzaXplXSxcbiAgICAgICAgW2NsaWNrT3V0c2lkZSwgdW5yZWYoZGlyZWN0aXZlKV0sXG4gICAgICBdXG5cbiAgICAgIHJldHVybiB3aXRoRGlyZWN0aXZlcyhjb250ZW50LCBkaXJlY3RpdmVzKVxuICAgIH1cblxuICAgIG9uTW91bnRlZCgoKSA9PiB7XG4gICAgICBhY3RpdmF0b3JSZWYudmFsdWUgPSBnZXRBY3RpdmF0b3IoKVxuXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgc2V0RGV0YWNoZWQodW5yZWYoY29udGVudFJlZikhKVxuICAgIH0pXG5cbiAgICBvbkJlZm9yZVVubW91bnQoKCkgPT4ge1xuICAgICAgcmVtb3ZlQWN0aXZhdG9yRXZlbnRzKClcbiAgICAgIHJlbW92ZURldGFjaGVkKGNvbnRlbnRSZWYudmFsdWUhKVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4gW1xuICAgICAgaCgnZGl2JywgeyBjbGFzczogeyAndi1tZW51JzogdHJ1ZSB9IH0pLFxuICAgICAgc2xvdHMuYWN0aXZhdG9yICYmIGdlbkFjdGl2YXRvclNsb3QoKSxcbiAgICAgIHVzZVRyYW5zaXRpb24oZ2VuQ29udGVudFNsb3QoKSwgJ2ZhZGUnKSxcbiAgICBdXG4gIH0sXG59KVxuIl19