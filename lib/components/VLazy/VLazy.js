import { defineComponent, h, ref, unref, onMounted } from 'vue';
export default defineComponent({
    props: {
        tag: {
            type: String,
            default: 'div'
        },
        rootMargin: {
            type: String,
            default: '0px'
        },
        threshold: {
            type: [Number, String],
            default: 0.1
        },
        transition: {
            type: String,
            default: 'fade'
        }
    },
    setup(props, { slots }) {
        const LAZY_ATTR = 'data-src';
        const containerRef = ref(null);
        const intersectionObserverOptions = {
            root: unref(containerRef),
            rootMargin: props.rootMargin,
            threshold: Number(props.threshold),
        };
        const mutationObserverOptions = {
            childList: true,
            subtree: true
        };
        let intersectionObserver;
        let mutationObserver;
        function onTransitionEnd() {
            this.classList.remove(`${props.transition}-enter-active`);
            this.removeEventListener('transitionend', onTransitionEnd);
        }
        function onEnter(entries, observer) {
            let duration = 0;
            entries.forEach((it) => {
                if (it.isIntersecting) {
                    it.target.classList.add(`${props.transition}-enter-from`);
                    requestAnimationFrame(() => {
                        it.target.src = it.target.dataset.src;
                        it.target.removeAttribute(LAZY_ATTR);
                        if (!duration) {
                            duration = parseFloat(getComputedStyle(it.target).transitionDuration) * 1000;
                        }
                        it.target.classList.add(`${props.transition}-enter-active`);
                        observer.unobserve(it.target);
                        setTimeout(() => {
                            it.target.classList.remove(`${props.transition}-enter-from`);
                        }, duration);
                        it.target.addEventListener('transitionend', onTransitionEnd);
                    });
                }
            });
        }
        function onMutation() {
            const elems = unref(containerRef).querySelectorAll(`*[${LAZY_ATTR}]`);
            elems.forEach((el) => {
                intersectionObserver.unobserve(el);
                intersectionObserver.observe(el);
            });
        }
        onMounted(() => {
            intersectionObserver = new IntersectionObserver(onEnter, intersectionObserverOptions);
            mutationObserver = new MutationObserver(onMutation);
            mutationObserver.observe(unref(containerRef), mutationObserverOptions);
            onMutation();
        });
        return () => h(props.tag, {
            class: 'v-lazy',
            ref: containerRef,
        }, slots.default?.());
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkxhenkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy92dWVsYW5kL3NyYy9jb21wb25lbnRzL1ZMYXp5L1ZMYXp5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFBO0FBRS9ELGVBQWUsZUFBZSxDQUFDO0lBQzdCLEtBQUssRUFBRTtRQUNMLEdBQUcsRUFBRTtZQUNILElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEtBQUs7U0FDZjtRQUNELFVBQVUsRUFBRTtZQUNWLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEtBQUs7U0FDZjtRQUNELFNBQVMsRUFBRTtZQUNULElBQUksRUFBRSxDQUFFLE1BQU0sRUFBRSxNQUFNLENBQUU7WUFDeEIsT0FBTyxFQUFFLEdBQUc7U0FDYjtRQUNELFVBQVUsRUFBRTtZQUNWLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLE1BQU07U0FDaEI7S0FDRjtJQUVELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUU7UUFDcEIsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFBO1FBQzVCLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBcUIsSUFBSSxDQUFDLENBQUE7UUFFbEQsTUFBTSwyQkFBMkIsR0FBRztZQUNsQyxJQUFJLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBRTtZQUMxQixVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7WUFDNUIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1NBQ25DLENBQUE7UUFFRCxNQUFNLHVCQUF1QixHQUFHO1lBQzlCLFNBQVMsRUFBRSxJQUFJO1lBQ2YsT0FBTyxFQUFFLElBQUk7U0FDZCxDQUFBO1FBRUQsSUFBSSxvQkFBMEMsQ0FBQTtRQUM5QyxJ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ZiwgdW5yZWYsIG9uTW91bnRlZCB9IGZyb20gJ3Z1ZSdcblxuZXhwb3J0IGRlZmF1bHQgZGVmaW5lQ29tcG9uZW50KHtcbiAgcHJvcHM6IHtcbiAgICB0YWc6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdkaXYnXG4gICAgfSxcbiAgICByb290TWFyZ2luOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnMHB4J1xuICAgIH0sXG4gICAgdGhyZXNob2xkOiB7XG4gICAgICB0eXBlOiBbIE51bWJlciwgU3RyaW5nIF0sXG4gICAgICBkZWZhdWx0OiAwLjFcbiAgICB9LFxuICAgIHRyYW5zaXRpb246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdmYWRlJ1xuICAgIH1cbiAgfSxcblxuICBzZXR1cChwcm9wcywgeyBzbG90cyB9KXtcbiAgICBjb25zdCBMQVpZX0FUVFIgPSAnZGF0YS1zcmMnXG4gICAgY29uc3QgY29udGFpbmVyUmVmID0gcmVmPEhUTUxFbGVtZW50IHwgbnVsbD4obnVsbClcblxuICAgIGNvbnN0IGludGVyc2VjdGlvbk9ic2VydmVyT3B0aW9ucyA9IHtcbiAgICAgIHJvb3Q6IHVucmVmKGNvbnRhaW5lclJlZikhLFxuICAgICAgcm9vdE1hcmdpbjogcHJvcHMucm9vdE1hcmdpbixcbiAgICAgIHRocmVzaG9sZDogTnVtYmVyKHByb3BzLnRocmVzaG9sZCksXG4gICAgfVxuXG4gICAgY29uc3QgbXV0YXRpb25PYnNlcnZlck9wdGlvbnMgPSB7XG4gICAgICBjaGlsZExpc3Q6IHRydWUsXG4gICAgICBzdWJ0cmVlOiB0cnVlXG4gICAgfVxuXG4gICAgbGV0IGludGVyc2VjdGlvbk9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlclxuICAgIGxldCBtdXRhdGlvbk9ic2VydmVyOiBNdXRhdGlvbk9ic2VydmVyXG5cbiAgICBmdW5jdGlvbiBvblRyYW5zaXRpb25FbmQoKXtcbiAgICAgIHRoaXMuY2xhc3NMaXN0LnJlbW92ZShgJHsgcHJvcHMudHJhbnNpdGlvbiB9LWVudGVyLWFjdGl2ZWApXG4gICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCBvblRyYW5zaXRpb25FbmQpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gb25FbnRlcihlbnRyaWVzOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5W10sIG9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlcil7XG4gICAgICBsZXQgZHVyYXRpb24gPSAwXG5cbiAgICAgIGVudHJpZXMuZm9yRWFjaCgoaXQ6IGFueSkgPT4ge1xuICAgICAgICBpZiAoaXQuaXNJbnRlcnNlY3RpbmcpIHtcblxuICAgICAgICAgIGl0LnRhcmdldC5jbGFzc0xpc3QuYWRkKGAkeyBwcm9wcy50cmFuc2l0aW9uIH0tZW50ZXItZnJvbWApXG5cbiAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgaXQudGFyZ2V0LnNyYyA9IGl0LnRhcmdldC5kYXRhc2V0LnNyY1xuICAgICAgICAgICAgaXQudGFyZ2V0LnJlbW92ZUF0dHJpYnV0ZShMQVpZX0FUVFIpXG5cbiAgICAgICAgICAgIGlmICghZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgZHVyYXRpb24gPSBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoaXQudGFyZ2V0KS50cmFuc2l0aW9uRHVyYXRpb24pICogMTAwMFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpdC50YXJnZXQuY2xhc3NMaXN0LmFkZChgJHsgcHJvcHMudHJhbnNpdGlvbiB9LWVudGVyLWFjdGl2ZWApXG5cbiAgICAgICAgICAgIG9ic2VydmVyLnVub2JzZXJ2ZShpdC50YXJnZXQpXG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICBpdC50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZShgJHsgcHJvcHMudHJhbnNpdGlvbiB9LWVudGVyLWZyb21gKVxuICAgICAgICAgICAgfSwgZHVyYXRpb24pXG5cbiAgICAgICAgICAgIGl0LnRhcmdldC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgb25UcmFuc2l0aW9uRW5kKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gb25NdXRhdGlvbigvKm11dGF0aW9uUmVjb3JkczogTXV0YXRpb25SZWNvcmRbXSovKXtcbiAgICAgIGNvbnN0IGVsZW1zID0gdW5yZWYoY29udGFpbmVyUmVmKSEucXVlcnlTZWxlY3RvckFsbChgKlskeyBMQVpZX0FUVFIgfV1gKVxuXG4gICAgICBlbGVtcy5mb3JFYWNoKChlbDogYW55KSA9PiB7XG4gICAgICAgIGludGVyc2VjdGlvbk9ic2VydmVyLnVub2JzZXJ2ZShlbClcbiAgICAgICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZShlbClcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgb25Nb3VudGVkKCgpID0+IHtcbiAgICAgIGludGVyc2VjdGlvbk9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKG9uRW50ZXIsIGludGVyc2VjdGlvbk9ic2VydmVyT3B0aW9ucylcbiAgICAgIG11dGF0aW9uT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihvbk11dGF0aW9uKVxuXG4gICAgICBtdXRhdGlvbk9ic2VydmVyLm9ic2VydmUodW5yZWYoY29udGFpbmVyUmVmKSEsIG11dGF0aW9uT2JzZXJ2ZXJPcHRpb25zKVxuICAgICAgb25NdXRhdGlvbigpXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiBoKHByb3BzLnRhZywge1xuICAgICAgY2xhc3M6ICd2LWxhenknLFxuICAgICAgcmVmOiBjb250YWluZXJSZWYsXG4gICAgfSwgc2xvdHMuZGVmYXVsdD8uKCkpXG4gIH1cbn0pXG4iXX0=